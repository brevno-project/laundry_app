# –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ RPC —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ queue

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

–ó–∞–º–µ–Ω–∏–ª–∏ –≤—Å–µ –ø—Ä—è–º—ã–µ SELECT –∑–∞–ø—Ä–æ—Å—ã –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `queue` –Ω–∞ RPC —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ:

#### 1. –§—É–Ω–∫—Ü–∏—è `joinQueue` (LaundryContext.tsx)
- **–ë—ã–ª–æ**: –ü—Ä—è–º–æ–π SELECT –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ "—É–∂–µ –≤ –æ—á–µ—Ä–µ–¥–∏"
- **–°—Ç–∞–ª–æ**: `supabase.rpc('has_active_queue_item', { p_student_id, p_date })`

- **–ë—ã–ª–æ**: –ü—Ä—è–º–æ–π SELECT –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è `max(queue_position)`
- **–°—Ç–∞–ª–æ**: `supabase.rpc('get_next_queue_position', { p_date })`

#### 2. –§—É–Ω–∫—Ü–∏–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞ –∑–∞–ø–∏—Å–µ–π
- **transferSelectedToToday**: –ó–∞–º–µ–Ω–∏–ª–∏ SELECT –Ω–∞ `get_queue_public`
- **transferSelectedToDate**: –ó–∞–º–µ–Ω–∏–ª–∏ SELECT –Ω–∞ `get_queue_public`

### –ù–æ–≤—ã–µ RPC —Ñ—É–Ω–∫—Ü–∏–∏ (—Å–æ–∑–¥–∞–Ω—ã):

#### `has_active_queue_item(p_student_id, p_date)`
```sql
-- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —É —Å—Ç—É–¥–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –∑–∞–ø–∏—Å—å –≤ –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ –¥–∞—Ç—É
-- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: boolean
```

#### `get_next_queue_position(p_date)`
```sql
-- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–µ–¥—É—é—â—É—é —Å–≤–æ–±–æ–¥–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –≤ –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ –¥–∞—Ç—É
-- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: integer
```

### –ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π:
- `fetchQueue()` - —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ `get_queue_public`
- –û–ø–µ—Ä–∞—Ü–∏–∏ INSERT/UPDATE/DELETE - –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é—Ç—Å—è RLS –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏
- `getUserQueueItem()` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –≤ –º–∞—Å—Å–∏–≤–µ `queue`

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

–¢–µ–ø–µ—Ä—å —Ç–∞–±–ª–∏—Ü–∞ `queue` –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫—Ä—ã—Ç–∞ –¥–ª—è –ø—Ä—è–º–æ–≥–æ —á—Ç–µ–Ω–∏—è:
- ‚ùå –ù–µ—Ç SELECT policy –Ω–∞ `queue`
- ‚úÖ –í—Å–µ —á—Ç–µ–Ω–∏–µ —á–µ—Ä–µ–∑ RPC —Ñ—É–Ω–∫—Ü–∏–∏ (SECURITY DEFINER)
- ‚úÖ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é—Ç –∑–∞–ø–∏—Å—å (INSERT/UPDATE/DELETE)

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤ Supabase:
   ```sql
   -- –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:
   supabase/migrations/20250104_add_queue_rpc_functions.sql
   ```

2. –£–¥–∞–ª–∏—Ç—å SELECT policy –¥–ª—è queue (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç):
   ```sql
   DROP POLICY IF EXISTS "queue_select_policy" ON public.queue;
   ```

3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É —Ñ—É–Ω–∫—Ü–∏–π:
   - –í—Å—Ç–∞—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å
   - –ü–µ—Ä–µ–Ω–æ—Å –∑–∞–ø–∏—Å–µ–π –º–µ–∂–¥—É –¥–∞—Ç–∞–º–∏
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∑–∏—Ü–∏–π
