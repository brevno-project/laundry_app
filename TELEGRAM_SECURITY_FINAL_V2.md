# ะะตะทะพะฟะฐัะฝะพััั Telegram ัะฒะตะดะพะผะปะตะฝะธะน - ะคะะะะะฌะะะฏ ะะะฅะะขะะะขะฃะะ V2

## โ ะงัะพ ะธัะฟัะฐะฒะปะตะฝะพ (ะบัะธัะธัะตัะบะธะต ะธะทะผะตะฝะตะฝะธั)

### 1. ะกััะดะตะฝัั ะผะพะณัั ะพัะฟัะฐะฒะปััั ัะฒะตะดะพะผะปะตะฝะธั ะฐะดะผะธะฝะฐะผ

**ะัะพะฑะปะตะผะฐ:** ะัะตะดัะดััะฐั ะฒะตััะธั ะฑะปะพะบะธัะพะฒะฐะปะฐ **ะฒัะตั** ะฝะต-ะฐะดะผะธะฝะพะฒ, ะฒะบะปััะฐั ัััะดะตะฝัะพะฒ, ะบะพัะพััะต ะดะพะปะถะฝั ัะฒะตะดะพะผะปััั ะฐะดะผะธะฝะพะฒ ะพ ะฝะฐัะฐะปะต/ะทะฐะฒะตััะตะฝะธะธ ััะธัะบะธ.

**ะะตัะตะฝะธะต:**
```typescript
// โ ะขะธะฟั ัะฒะตะดะพะผะปะตะฝะธะน, ะบะพัะพััะต ัััะดะตะฝัั ะผะพะณัั ะพัะฟัะฐะฒะปััั ะฐะดะผะธะฝะฐะผ
const STUDENT_TO_ADMIN_TYPES = ['washing_started_by_student', 'washing_finished'];

// ะะดะผะธะฝ ะผะพะถะตั ะพัะฟัะฐะฒะปััั ะปัะฑัะต ัะฒะตะดะพะผะปะตะฝะธั
if (!isAdmin) {
  // ะะต ะฐะดะผะธะฝ: ัะฐะทัะตัะฐะตะผ ัะพะปัะบะพ ัััะดะตะฝััะบะธะต ัะธะฟั
  if (!isStudentToAdmin) {
    return 403; // Forbidden
  }
  
  // ะะฐะปะธะดะฐัะธั ะฒะปะฐะดะตะฝะธั ัะตัะตะท queue_item_id
  ...
}
```

---

### 2. ะะฐัะธัะฐ ะพั ะฟะพะดะผะตะฝั ัะตัะตะท `queue_item_id`

**ะัะพะฑะปะตะผะฐ:** ะกััะดะตะฝั ะผะพะณ ะพัะฟัะฐะฒะธัั `student_id` ะดััะณะพะณะพ ัะตะปะพะฒะตะบะฐ ะธ ัะฟะฐะผะธัั ะฐะดะผะธะฝะฐะผ ะพั ะตะณะพ ะธะผะตะฝะธ.

**ะะตัะตะฝะธะต:**
```typescript
// 1. ะกััะดะตะฝั ะพะฑัะทะฐะฝ ะฟะตัะตะดะฐัั queue_item_id
if (!notification.queue_item_id) {
  return 400; // Bad Request
}

// 2. ะัะพะฒะตััะตะผ ััะพ queue item ะฟัะธะฝะฐะดะปะตะถะธั ัััะดะตะฝัั
const { data: queueItem } = await admin
  .from('queue')
  .select('id, student_id')
  .eq('id', notification.queue_item_id)
  .single();

// 3. ะกัะฐะฒะฝะธะฒะฐะตะผ ะฒะปะฐะดะตะปััะฐ
if (queueItem.student_id !== caller.id) {
  return 403; // Forbidden: Not your queue item
}

// 4. ะัะธะฝัะดะธัะตะปัะฝะพ ะฒัััะฐะฒะปัะตะผ ะดะฐะฝะฝัะต ะธะท caller
notification.student_id = caller.id;
notification.full_name = caller.full_name;
```

**ะะตะทัะปััะฐั:** ะกััะดะตะฝั ะผะพะถะตั ัะฒะตะดะพะผะปััั **ัะพะปัะบะพ ะฟัะพ ัะฒะพั** ะทะฐะฟะธัั ะฒ ะพัะตัะตะดะธ.

---

### 3. JWT ัะพะบะตะฝ ะฒ ะทะฐะฟัะพัะฐั ะพั ัััะดะตะฝัะพะฒ

**ะะทะผะตะฝะตะฝะธั ะฒ `StudentActions.tsx`:**
```typescript
// ะะพะปััะธัั JWT ัะพะบะตะฝ ะธะท Supabase session
const { data: { session } } = await supabase.auth.getSession();

// ะัะฟัะฐะฒะธัั ั Authorization header
fetch('/api/telegram/notify', {
  headers: { 
    'Authorization': `Bearer ${session.access_token}`
  },
  body: JSON.stringify({
    type: 'washing_started_by_student',
    queue_item_id: myQueueItem.id, // โ ะะฑัะทะฐัะตะปัะฝะพ
    ...
  })
});
```

---

## ๐ ะคะธะฝะฐะปัะฝะฐั ะฐััะธัะตะบัััะฐ ะฑะตะทะพะฟะฐัะฝะพััะธ

### ะะฐััะธัะฐ ะฟัะฐะฒ ะดะพัััะฟะฐ

| ะขะธะฟ ัะฒะตะดะพะผะปะตะฝะธั | ะะดะผะธะฝ | ะกััะดะตะฝั | ะขัะตะฑัะตััั queue_item_id |
|----------------|-------|---------|------------------------|
| `admin_call_for_key` | โ | โ | โ |
| `admin_return_key` | โ | โ | โ |
| `key_issued` | โ | โ | โ |
| `washing_started` | โ | โ | โ |
| `washing_done` | โ | โ | โ |
| `joined` | โ | โ | โ |
| `left` | โ | โ | โ |
| `updated` | โ | โ | โ |
| **`washing_started_by_student`** | โ | โ | **โ** |
| **`washing_finished`** | โ | โ | **โ** |

---

### ะะปะณะพัะธัะผ ะฟัะพะฒะตัะบะธ ะฟัะฐะฒ

```
1. ะัะพะฒะตัะธัั JWT ัะพะบะตะฝ
   โ
2. ะะพะปััะธัั caller ะธะท students ะฟะพ user_id
   โ
3. ะัะพะฒะตัะธัั ััะพ ะฝะต ะทะฐะฑะฐะฝะตะฝ
   โ
4. ะะฟัะตะดะตะปะธัั ัะพะปั: isAdmin = is_admin || is_super_admin
   โ
5. ะัะปะธ ะะ ะฐะดะผะธะฝ:
   โโ ะัะพะฒะตัะธัั ััะพ ัะธะฟ ะฒ STUDENT_TO_ADMIN_TYPES
   โโ ะัะพะฒะตัะธัั ะฝะฐะปะธัะธะต queue_item_id
   โโ ะัะพะฒะตัะธัั ะฒะปะฐะดะตะฝะธะต: queue.student_id == caller.id
   โโ ะัะธะฝัะดะธัะตะปัะฝะพ ะฒัััะฐะฒะธัั student_id ะธ full_name ะธะท caller
   โ
6. ะัะฟัะฐะฒะธัั ัะฒะตะดะพะผะปะตะฝะธะต
```

---

## ๐ ะะฐัััััะธะทะฐัะธั ัะฒะตะดะพะผะปะตะฝะธะน

### ะขะพะปัะบะพ ัััะดะตะฝัั (student-only):
- `admin_call_for_key` - ะฐะดะผะธะฝ ะฟะพะทะฒะฐะป ะทะฐ ะบะปััะพะผ
- `admin_return_key` - ะฐะดะผะธะฝ ะฟัะพัะธั ะฒะตัะฝััั ะบะปัั
- `key_issued` - ะบะปัั ะฒัะดะฐะฝ

### ะขะพะปัะบะพ ะฐะดะผะธะฝั (admin-only):
- `washing_started_by_student` - ัััะดะตะฝั ะฝะฐัะฐะป ััะธัะฐัั โ
- `washing_finished` - ัััะดะตะฝั ะทะฐะบะพะฝัะธะป ััะธัะฐัั โ
- `joined` - ะฝะพะฒัะน ัััะดะตะฝั ะฒััะฐะป ะฒ ะพัะตัะตะดั

### ะะฑะพะธะผ (ะตัะปะธ ะฝะต ัะบะฐะทะฐะฝะพ ะธะฝะพะต):
- `washing_started` - ะฐะดะผะธะฝ ะทะฐะฟัััะธะป ััะธัะบั
- `washing_done` - ััะธัะบะฐ ะทะฐะฒะตััะตะฝะฐ
- `left` - ัััะดะตะฝั ะฟะพะบะธะฝัะป ะพัะตัะตะดั
- `updated` - ะพะฑะฝะพะฒะปะตะฝะธะต ะดะฐะฝะฝัั

---

## ๐ก๏ธ ะะฐัะธัะฐ ะพั ะฐัะฐะบ

### 1. ะะตัะฐะฝะบัะธะพะฝะธัะพะฒะฐะฝะฝัะน ะดะพัััะฟ
**ะัะฐะบะฐ:** ะะปะพัะผััะปะตะฝะฝะธะบ ะฟััะฐะตััั ะพัะฟัะฐะฒะธัั ัะฒะตะดะพะผะปะตะฝะธะต ะฑะตะท ะฐะฒัะพัะธะทะฐัะธะธ.
**ะะฐัะธัะฐ:** API ะฒะพะทะฒัะฐัะฐะตั `401 Unauthorized` ะฑะตะท JWT ัะพะบะตะฝะฐ.

### 2. ะะพะดะดะตะปะบะฐ ัะพะบะตะฝะฐ
**ะัะฐะบะฐ:** ะะปะพัะผััะปะตะฝะฝะธะบ ะฟััะฐะตััั ะฟะพะดะดะตะปะฐัั JWT ัะพะบะตะฝ.
**ะะฐัะธัะฐ:** ะขะพะบะตะฝ ะฟะพะดะฟะธัะฐะฝ Supabase, ะฟัะพะฒะตััะตััั ัะตัะตะท `admin.auth.getUser()`.

### 3. ะะพะฒััะตะฝะธะต ะฟัะธะฒะธะปะตะณะธะน
**ะัะฐะบะฐ:** ะกััะดะตะฝั ะฟััะฐะตััั ะพัะฟัะฐะฒะธัั admin-only ัะฒะตะดะพะผะปะตะฝะธะต.
**ะะฐัะธัะฐ:** API ะฟัะพะฒะตััะตั ัะธะฟ ัะฒะตะดะพะผะปะตะฝะธั, ะฒะพะทะฒัะฐัะฐะตั `403 Forbidden`.

### 4. ะะพะดะผะตะฝะฐ student_id
**ะัะฐะบะฐ:** ะกััะดะตะฝั ะพัะฟัะฐะฒะปัะตั `student_id` ะดััะณะพะณะพ ัะตะปะพะฒะตะบะฐ.
**ะะฐัะธัะฐ:** 
- ะขัะตะฑัะตััั `queue_item_id`
- ะัะพะฒะตััะตััั ะฒะปะฐะดะตะฝะธะต ัะตัะตะท `queue.student_id == caller.id`
- `student_id` ะฟัะธะฝัะดะธัะตะปัะฝะพ ะฒัััะฐะฒะปัะตััั ะธะท `caller`

### 5. ะกะฟะฐะผ ะพั ััะถะพะณะพ ะธะผะตะฝะธ
**ะัะฐะบะฐ:** ะกััะดะตะฝั ัะฟะฐะผะธั ัะฒะตะดะพะผะปะตะฝะธัะผะธ ะฟัะพ ััะถัั ะทะฐะฟะธัั ะฒ ะพัะตัะตะดะธ.
**ะะฐัะธัะฐ:** 
- ะัะพะฒะตัะบะฐ ะฒะปะฐะดะตะฝะธั `queue_item_id`
- Rate limiting ะฝะฐ ะบะปะธะตะฝัะต (5 ะผะธะฝัั cooldown, ะผะฐะบั 3 ัะฒะตะดะพะผะปะตะฝะธั)

### 6. ะฃัะตัะบะฐ ะดะฐะฝะฝัั
**ะัะฐะบะฐ:** ะะพะฟััะบะฐ ะฒััะธัะฐัั `telegram_chat_id` ัะตัะตะท timing attack.
**ะะฐัะธัะฐ:** 
- ะะปะธะตะฝั ะฝะต ะธะผะตะตั ะดะพัััะฟะฐ ะบ `telegram_chat_id`
- API ะฝะต ะฒะพะทะฒัะฐัะฐะตั `telegram_chat_id` ะฒ ะพัะฒะตัะต
- `service_role` ะธัะฟะพะปัะทัะตััั ัะพะปัะบะพ ะฝะฐ ัะตัะฒะตัะต

---

## โ ะงะตะบ-ะปะธัั ะฑะตะทะพะฟะฐัะฝะพััะธ

- [x] JWT ัะพะบะตะฝ ะฟัะพะฒะตััะตััั ะฝะฐ ัะตัะฒะตัะต
- [x] ะัะฐะฒะฐ ะฟัะพะฒะตัััััั ะฒ ะะ ะฝะฐ ะบะฐะถะดัะน ะทะฐะฟัะพั
- [x] ะกััะดะตะฝัั ะผะพะณัั ะพัะฟัะฐะฒะปััั ัะฒะตะดะพะผะปะตะฝะธั ะฐะดะผะธะฝะฐะผ
- [x] ะกััะดะตะฝัั ะผะพะณัั ัะฒะตะดะพะผะปััั ัะพะปัะบะพ ะฟัะพ ัะฒะพะธ ะทะฐะฟะธัะธ
- [x] `queue_item_id` ะพะฑัะทะฐัะตะปะตะฝ ะดะปั ัััะดะตะฝััะบะธั ัะฒะตะดะพะผะปะตะฝะธะน
- [x] ะะปะฐะดะตะฝะธะต ะฟัะพะฒะตััะตััั ัะตัะตะท `queue.student_id`
- [x] `student_id` ะธ `full_name` ะฟัะธะฝัะดะธัะตะปัะฝะพ ะฒัััะฐะฒะปััััั ะธะท `caller`
- [x] `service_role` ะบะปัั ััะฐะฝะธััั ัะพะปัะบะพ ะฝะฐ ัะตัะฒะตัะต
- [x] `TELEGRAM_BOT_TOKEN` ััะฐะฝะธััั ัะพะปัะบะพ ะฝะฐ ัะตัะฒะตัะต
- [x] ะะปะธะตะฝั ะฝะต ะผะพะถะตั ะฟะพะดะดะตะปะฐัั ัะตะบัั ัะฒะตะดะพะผะปะตะฝะธั
- [x] ะกััะดะตะฝัั ะฝะต ะฟะพะปััะฐัั ัะฒะตะดะพะผะปะตะฝะธั ะพ ะฝะพะฒัั ัััะดะตะฝัะฐั ะฒ ะพัะตัะตะดะธ
- [x] ะะฐะฑะฐะฝะตะฝะฝัะต ะฟะพะปัะทะพะฒะฐัะตะปะธ ะฝะต ะผะพะณัั ะพัะฟัะฐะฒะปััั ัะฒะตะดะพะผะปะตะฝะธั
- [x] API ะปะพะณะธััะตั ะฒัะต ะฟะพะฟััะบะธ ะดะพัััะฟะฐ

---

## ๐ ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั

### Vercel Environment Variables (ะพะฑัะทะฐัะตะปัะฝะพ):
```
SUPABASE_SERVICE_ROLE_KEY=<service_role_key>
TELEGRAM_BOT_TOKEN=<bot_token_from_BotFather>
TELEGRAM_ADMIN_CHAT_ID=<optional_main_admin_chat_id>
```

### .env.local (ะดะปั ะปะพะบะฐะปัะฝะพะน ัะฐะทัะฐะฑะพัะบะธ):
```
SUPABASE_SERVICE_ROLE_KEY=<service_role_key>
TELEGRAM_BOT_TOKEN=<bot_token_from_BotFather>
TELEGRAM_ADMIN_CHAT_ID=<optional_main_admin_chat_id>
```

โ๏ธ **ะะะะะะะ ะฝะต ะบะพะผะผะธัะธัั .env.local ะฒ Git!**

---

## ๐ ะัะพะณะพะฒะฐั ะฐััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   ะะปะธะตะฝั (ะฑัะฐัะทะตั)                                      โ
โ                                                         โ
โ   ะะดะผะธะฝ:                                                โ
โ   - ะัะฑัะต ัะฒะตะดะพะผะปะตะฝะธั                                   โ
โ   - ะะตะท queue_item_id                                   โ
โ                                                         โ
โ   ะกััะดะตะฝั:                                              โ
โ   - ะขะพะปัะบะพ washing_started_by_student, washing_finished โ
โ   - ะก ะพะฑัะทะฐัะตะปัะฝัะผ queue_item_id                        โ
โ   - JWT ัะพะบะตะฝ ะฒ Authorization header                    โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ POST /api/telegram/notify
                 โ Authorization: Bearer <jwt>
                 โ Body: { type, queue_item_id, ... }
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   API Route /api/telegram/notify                        โ
โ                                                         โ
โ  1. ะัะพะฒะตัะธัั JWT ัะพะบะตะฝ                                 โ
โ  2. ะะพะปััะธัั caller ะธะท students                         โ
โ  3. ะัะพะฒะตัะธัั is_banned                                 โ
โ  4. ะะฟัะตะดะตะปะธัั ัะพะปั (admin/student)                     โ
โ  5. ะัะปะธ ัััะดะตะฝั:                                       โ
โ     - ะัะพะฒะตัะธัั ัะธะฟ ัะฒะตะดะพะผะปะตะฝะธั                         โ
โ     - ะัะพะฒะตัะธัั queue_item_id                           โ
โ     - ะัะพะฒะตัะธัั ะฒะปะฐะดะตะฝะธะต (queue.student_id == caller.id)โ
โ     - ะัะธะฝัะดะธัะตะปัะฝะพ ะฒัััะฐะฒะธัั student_id ะธะท caller      โ
โ  6. ะะพะปััะธัั telegram_chat_id (service_role)            โ
โ  7. ะกัะพัะผะธัะพะฒะฐัั ัะพะพะฑัะตะฝะธะต                              โ
โ  8. ะัะฟัะฐะฒะธัั ะฒ Telegram API                            โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Telegram API                                           โ
โ                                                         โ
โ  - ะัะฟัะฐะฒะบะฐ ัะพะพะฑัะตะฝะธะน ัััะดะตะฝัะฐะผ                         โ
โ  - ะัะฟัะฐะฒะบะฐ ัะพะพะฑัะตะฝะธะน ะฐะดะผะธะฝะฐะผ                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ฏ ะะตะทัะปััะฐั

โ **ะะตะทะพะฟะฐัะฝะพ:** ะขะพะปัะบะพ ะฐะฒัะพัะธะทะพะฒะฐะฝะฝัะต ะฟะพะปัะทะพะฒะฐัะตะปะธ ะผะพะณัั ะพัะฟัะฐะฒะปััั ัะฒะตะดะพะผะปะตะฝะธั
โ **ะะธะฑะบะพ:** ะกััะดะตะฝัั ะผะพะณัั ัะฒะตะดะพะผะปััั ะฐะดะผะธะฝะพะฒ ะพ ะฝะฐัะฐะปะต/ะทะฐะฒะตััะตะฝะธะธ ััะธัะบะธ
โ **ะะฐัะธัะตะฝะพ ะพั ะฟะพะดะผะตะฝั:** ะกััะดะตะฝัั ะผะพะณัั ัะฒะตะดะพะผะปััั ัะพะปัะบะพ ะฟัะพ ัะฒะพะธ ะทะฐะฟะธัะธ
โ **ะัะฐะฒะธะปัะฝะฐั ะผะฐัััััะธะทะฐัะธั:** ะกััะดะตะฝัั ะฝะต ะฟะพะปััะฐัั ัะฒะตะดะพะผะปะตะฝะธั ะพ ะฝะพะฒัั ัััะดะตะฝัะฐั
โ **ะะฐัะธัะตะฝะพ:** `service_role` ะธ `TELEGRAM_BOT_TOKEN` ััะฐะฝัััั ะฝะฐ ัะตัะฒะตัะต
โ **ะะพะณะธััะตััั:** ะัะต ะฟะพะฟััะบะธ ะดะพัััะฟะฐ ะทะฐะฟะธััะฒะฐัััั ะฒ ะปะพะณะธ

---

## ๐ ะกะฒัะทะฐะฝะฝัะต ัะฐะนะปั

- `src/app/api/telegram/notify/route.ts` - API route ั ะฟัะพะฒะตัะบะพะน JWT ะธ ะฒะปะฐะดะตะฝะธั
- `src/lib/telegram.ts` - ะบะปะธะตะฝััะบะฐั ััะฝะบัะธั ะดะปั ะฐะดะผะธะฝะพะฒ
- `src/components/StudentActions.tsx` - ะบะฝะพะฟะบะธ ัััะดะตะฝัะฐ ั JWT ัะพะบะตะฝะพะผ
- `src/lib/supabase-admin.ts` - admin ะบะปะธะตะฝั ั service_role
- `src/types/index.ts` - ัะธะฟั ั queue_item_id
- `TELEGRAM_BOT_UPDATE.md` - ะธะฝััััะบัะธะธ ะดะปั ะพะฑะฝะพะฒะปะตะฝะธั ะฑะพัะฐ
- `CHECK_TELEGRAM.md` - ะดะธะฐะณะฝะพััะธะบะฐ ะฟัะพะฑะปะตะผ ั ัะฒะตะดะพะผะปะตะฝะธัะผะธ
