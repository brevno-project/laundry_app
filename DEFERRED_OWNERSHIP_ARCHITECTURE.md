# üéØ –§–∏–Ω–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤–ª–∞–¥–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥—å—é: –¥–≤—É—Ö—Ñ–∞–∑–Ω–∞—è –º–æ–¥–µ–ª—å

## ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞

**–°—Ü–µ–Ω–∞—Ä–∏–π "–∞–¥–º–∏–Ω –ø–æ—Å—Ç–∞–≤–∏–ª ‚Üí —Å—Ç—É–¥–µ–Ω—Ç –∑–∞–±—Ä–∞–ª"** —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ:

1. **–ê–¥–º–∏–Ω** —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ –æ—á–µ—Ä–µ–¥–∏ —Å `user_id = NULL`
2. **–°—Ç—É–¥–µ–Ω—Ç** –ª–æ–≥–∏–Ω–∏—Ç—Å—è ‚Üí –∑–∞–ø–∏—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∫ –Ω–µ–º—É
3. **–°—Ç—É–¥–µ–Ω—Ç** –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø–∏—Å—å—é (–≤—ã–π—Ç–∏, –æ–±–Ω–æ–≤–∏—Ç—å)
4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –Ω–∏–∫—Ç–æ –Ω–µ –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —á—É–∂–∏–º–∏ –∑–∞–ø–∏—Å—è–º–∏

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –ù–æ–≤–∞—è SQL —Ñ—É–Ω–∫—Ü–∏—è `is_queue_owner(queue)`

```sql
-- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–Ω–∏—è –∑–∞–ø–∏—Å—å—é
create or replace function public.is_queue_owner(q queue)
returns boolean
language sql
security definer
set search_path = public
as $$
  select
    -- –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ user_id
    (q.user_id is not null and q.user_id = auth.uid())

    OR

    -- –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å –µ—â—ë –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞, –Ω–æ —Å—Ç—É–¥–µ–Ω—Ç –º–æ–π
    (
      q.user_id is null
      and exists (
        select 1
        from students s
        where s.id = q.student_id
          and s.user_id = auth.uid()
      )
    );
$$;
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏

- **DELETE**: `is_queue_owner(queue) OR is_admin() OR is_super_admin()`
- **UPDATE**: `is_queue_owner(queue) OR is_admin() OR is_super_admin()`  
- **INSERT**: –ê–¥–º–∏–Ω—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥–ª—è –ª—é–±–æ–≥–æ, —Å—Ç—É–¥–µ–Ω—Ç—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–µ–±—è

### 3. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

#### `joinQueue` - –ø–∏—à–µ–º `user_id` –µ—Å–ª–∏ –µ—Å—Ç—å —Å–µ—Å—Å–∏—è
```ts
const { data: authData } = await supabase.auth.getSession();
const currentUserId = authData.session?.user?.id || null;

const newItem = {
  student_id: user.student_id,
  user_id: currentUserId,  // üîë –ö–ª—é—á–µ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
  // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
};
```

#### `leaveQueue` - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏
```ts
if (error) {
  console.error('leaveQueue error:', error);
  throw new Error(error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–π—Ç–∏ –∏–∑ –æ—á–µ—Ä–µ–¥–∏');
}
```

#### `claimMyQueueItems` - –∞–≤—Ç–æ–ø—Ä–∏–≤—è–∑–∫–∞ —á–µ—Ä–µ–∑ RPC (SECURITY DEFINER)
```ts
const claimMyQueueItems = async () => {
  // ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π RPC –≤—ã–∑–æ–≤, –æ–±—Ö–æ–¥–∏—Ç RLS
  const { error } = await supabase.rpc('claim_my_queue_items');
};
```

**SQL —Ñ—É–Ω–∫—Ü–∏—è:**
```sql
create or replace function public.claim_my_queue_items()
returns void
language plpgsql
security definer
set search_path = public
as $$
begin
  update queue q
  set user_id = auth.uid()
  where q.user_id is null
    and exists (
      select 1
      from students s
      where s.id = q.student_id
        and s.user_id = auth.uid()
    );
end;
$$;
```

---

## üîÑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç (flow)

### –§–∞–∑–∞ 1: –ê–¥–º–∏–Ω —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å
```sql
INSERT INTO queue (
  student_id = 'student-uuid',
  user_id = NULL,  -- ‚Üê –µ—â–µ –Ω–µ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞
  ...
);
```

### –§–∞–∑–∞ 2: –°—Ç—É–¥–µ–Ω—Ç –ª–æ–≥–∏–Ω–∏—Ç—Å—è (RPC SECURITY DEFINER)
```sql
-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ RPC —Ñ—É–Ω–∫—Ü–∏—é
-- SECURITY DEFINER –æ–±—Ö–æ–¥–∏—Ç RLS, –Ω–æ auth.uid() –≤—Å—ë –µ—â—ë —Ä–∞–±–æ—Ç–∞–µ—Ç!
CALL public.claim_my_queue_items();
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ:**
- ‚úÖ –§—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç –∏–º–µ–Ω–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞ (SECURITY DEFINER)
- ‚úÖ `auth.uid()` –≤—Å—ë –µ—â—ë –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- ‚úÖ –°—Ç—É–¥–µ–Ω—Ç –º–æ–∂–µ—Ç –∑–∞–±—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ –°–í–û–ò –∑–∞–ø–∏—Å–∏
- ‚úÖ RLS –Ω–µ –Ω—É–∂–µ–Ω –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏
- ‚úÖ –ù–∏–∫–∞–∫–∏—Ö 403 –æ—à–∏–±–æ–∫

### –§–∞–∑–∞ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–Ω–∏—è (RLS)
```sql
-- –î–ª—è DELETE/UPDATE –ø—Ä–æ–≤–µ—Ä—è–µ—Ç is_queue_owner()
SELECT public.is_queue_owner(queue) 
-- –í–µ—Ä–Ω–µ—Ç true –µ—Å–ª–∏:
--   1) queue.user_id = auth.uid()                    (—É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω–æ)
--   2) queue.user_id IS NULL AND students.user_id = auth.uid() (–æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ)
```

---

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### ‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–æ:
- **–°—Ç—É–¥–µ–Ω—Ç** –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –°–í–û–ò–ú–ò –∑–∞–ø–∏—Å—è–º–∏ (–≤–∫–ª—é—á–∞—è —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∞–¥–º–∏–Ω–æ–º)
- **–ê–¥–º–∏–Ω** –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –õ–Æ–ë–´–ú–ò –∑–∞–ø–∏—Å—è–º–∏
- **–°—É–ø–µ—Ä–∞–¥–º–∏–Ω** –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –õ–Æ–ë–´–ú–ò –∑–∞–ø–∏—Å—è–º–∏

### ‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω–æ:
- **–°—Ç—É–¥–µ–Ω—Ç** –Ω–µ –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —á—É–∂–∏–º–∏ –∑–∞–ø–∏—Å—è–º–∏
- **Anon** –Ω–µ –º–æ–∂–µ—Ç –Ω–∏—á–µ–≥–æ –∏–∑–º–µ–Ω—è—Ç—å
- **Authenticated** –Ω–µ –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å —á—É–∂–∏–µ –∑–∞–ø–∏—Å–∏

---

## üìù –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤ Supabase
```sql
-- –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:
supabase/migrations/20250104_deferred_ownership_architecture.sql
```

### 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–∏:
- ‚úÖ –ê–¥–º–∏–Ω —Å—Ç–∞–≤–∏—Ç –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞ –≤ –æ—á–µ—Ä–µ–¥—å
- ‚úÖ –°—Ç—É–¥–µ–Ω—Ç –ª–æ–≥–∏–Ω–∏—Ç—Å—è ‚Üí –≤–∏–¥–∏—Ç –∑–∞–ø–∏—Å—å –∏ –º–æ–∂–µ—Ç –≤—ã–π—Ç–∏
- ‚úÖ –û–±—ã—á–Ω—ã–π —Å—Ç—É–¥–µ–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —á—É–∂–∏–º–∏ –∑–∞–ø–∏—Å—è–º–∏
- ‚úÖ –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –≤—Å–µ–º–∏ –∑–∞–ø–∏—Å—è–º–∏

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

**–ë–æ–ª—å—à–µ –Ω–∏–∫–∞–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º —Å "–Ω–µ –º–æ–≥—É –≤—ã–π—Ç–∏ –∏–∑ –æ—á–µ—Ä–µ–¥–∏"!**

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç:
- –ê–¥–º–∏–Ω–∞–º —Å—Ç–∞–≤–∏—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å –ª—é–±—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
- –°—Ç—É–¥–µ–Ω—Ç–∞–º "–ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞—Ç—å" –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–æ–ª–Ω—É—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ RLS

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∑–∞–∫—Ä—ã—Ç–∞ –Ω–∞ 100%.**
