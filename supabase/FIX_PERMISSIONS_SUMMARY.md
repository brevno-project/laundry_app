# Исправление прав доступа после добавления аватаров

## Проблемы найденные

### 1. Политики RLS в Supabase
После добавления функции аватаров были изменены политики RLS:

- **`students_update_authenticated`** - разрешала обновлять только свою запись (`auth.uid() = user_id`)
- **`queue_insert_authenticated_or_admin`** - разрешала вставку только если `auth.uid() = user_id`

**Результат:** Админы не могли обновлять других студентов и добавлять их в очередь.

### 2. Проверки в LaundryContext.tsx
Были найдены проблемные проверки, которые блокировали действия **для всех админов** (включая суперадминов):

1. **`adminAddToQueue`** (строка 967):
   - Блокировала добавление супер-админов в очередь для ВСЕХ админов
   
2. **`banStudent`** (строка 1568):
   - Блокировала бан супер-админов для ВСЕХ админов
   
3. **`updateStudent`** (строка 1708):
   - Блокировала редактирование супер-админов для ВСЕХ админов

**Результат:** Даже суперадмины не могли управлять другими админами.

## Решение

### 1. ✅ Исправлены проверки в коде

Теперь проверки применяются правильно:

- **Суперадмины** могут работать со ВСЕМИ (включая админов)
- **Обычные админы** могут работать только с НЕ-админами
- **Пользователи** могут управлять только своими данными

### 2. ✅ Создана миграция для восстановления политик RLS

Файл: `supabase/migrations/20250123_restore_admin_permissions.sql`

**Новая структура политик:**

#### Для таблицы `students`:
- `students_update_own` - пользователи могут обновлять свою запись (аватар и т.д.)
- `students_update_super_admin` - суперадмины могут обновлять ВСЕХ
- `students_update_admin` - админы могут обновлять только НЕ-админов
- `students_delete_super_admin` - суперадмины могут удалять всех (кроме себя)
- `students_delete_admin` - админы могут удалять только НЕ-админов

#### Для таблицы `queue`:
- `queue_insert_own` - пользователи могут добавлять себя
- `queue_insert_super_admin` - суперадмины могут добавлять всех
- `queue_insert_admin` - админы могут добавлять только НЕ-админов
- `queue_update_own` - пользователи могут обновлять свои записи
- `queue_update_super_admin` - суперадмины могут обновлять все записи
- `queue_update_admin` - админы могут обновлять записи НЕ-админов
- `queue_delete_own` - пользователи могут удалять свои записи
- `queue_delete_super_admin` - суперадмины могут удалять все записи
- `queue_delete_admin` - админы могут удалять записи НЕ-админов

## Как применить

### Шаг 1: Применить миграцию в Supabase

1. Открыть Supabase SQL Editor
2. Скопировать весь SQL из файла `supabase/migrations/20250123_restore_admin_permissions.sql`
3. Выполнить SQL
4. Проверить что все политики применились без ошибок

### Шаг 2: Проверить работу

1. Войти как **суперадмин**:
   - ✅ Должен мочь добавлять админов в очередь
   - ✅ Должен мочь редактировать админов
   - ✅ Должен мочь банить админов (кроме суперадминов)
   - ✅ Должен мочь удалять админов

2. Войти как **обычный админ**:
   - ✅ Должен мочь добавлять пользователей в очередь
   - ✅ Должен мочь редактировать пользователей
   - ✅ Должен мочь банить пользователей
   - ✅ Должен мочь удалять пользователей
   - ❌ НЕ должен мочь добавлять админов в очередь
   - ❌ НЕ должен мочь редактировать админов
   - ❌ НЕ должен мочь банить админов
   - ❌ НЕ должен мочь удалять админов

3. Войти как **обычный пользователь**:
   - ✅ Должен мочь обновлять свой аватар
   - ✅ Должен мочь добавлять себя в очередь
   - ✅ Должен мочь управлять своими записями в очереди
   - ❌ НЕ должен мочь управлять другими пользователями

## Итоговая структура прав

### СУПЕРАДМИН может:
✅ Обновлять ВСЕХ студентов
✅ Удалять ВСЕХ студентов (кроме себя)
✅ Добавлять ВСЕХ в очередь
✅ Обновлять/удалять ВСЕ записи в очереди
✅ Управлять правами других админов

### ОБЫЧНЫЙ АДМИН может:
✅ Обновлять только НЕ-админов
✅ Удалять только НЕ-админов
✅ Добавлять в очередь только НЕ-админов
✅ Обновлять/удалять записи в очереди только НЕ-админов
❌ НЕ МОЖЕТ управлять админами и суперадминами

### ОБЫЧНЫЙ ПОЛЬЗОВАТЕЛЬ может:
✅ Обновлять свою запись (аватар и т.д.)
✅ Добавлять себя в очередь
✅ Обновлять/удалять свои записи в очереди
❌ НЕ МОЖЕТ управлять другими пользователями

## Что исправлено в коде (LaundryContext.tsx)

### adminAddToQueue (строка ~965)
**Было:**
```typescript
// Блокировало добавление супер-админов для ВСЕХ
if (studentId && students.find(s => s.id === studentId)?.is_super_admin) {
  throw new Error('Нельзя ставить в очередь супер-админов');
}
```

**Стало:**
```typescript
// Обычный админ не может добавлять админов
if (!isSuperAdmin && (student.is_admin || student.is_super_admin)) {
  alert('Только супер-админ может добавлять админов в очередь');
  return;
}
```

### banStudent (строка ~1567)
**Было:**
```typescript
// Блокировало бан супер-админов для ВСЕХ
if (targetStudent.is_super_admin) {
  throw new Error('Нельзя банить супер-админов');
}
```

**Стало:**
```typescript
// Обычный админ не может банить админов
if (!isSuperAdmin && (targetStudent.is_admin || targetStudent.is_super_admin)) {
  throw new Error('Только супер-админ может банить админов');
}

// Нельзя банить супер-админов (даже супер-админу)
if (targetStudent.is_super_admin) {
  throw new Error('Нельзя банить супер-админов');
}
```

### updateStudent (строка ~1707)
**Было:**
```typescript
// Блокировало редактирование супер-админов для ВСЕХ
if (targetStudent.is_super_admin && !isSuperAdmin) {
  throw new Error('Нельзя редактировать супер-админов');
}
```

**Стало:**
```typescript
// Обычный админ не может редактировать админов
if (!isSuperAdmin && (targetStudent.is_admin || targetStudent.is_super_admin)) {
  throw new Error('Только супер-админ может редактировать админов');
}
```

---

**Дата исправления:** 2025-01-23
**Файлы изменены:**
- `src/contexts/LaundryContext.tsx`
- `supabase/migrations/20250123_restore_admin_permissions.sql`
