# üéØ –§–∏–Ω–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ—á–µ—Ä–µ–¥–∏ - –∫—Ä–∞—Ç–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üß© –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç `is_queue_owner()`

–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–∞–¥–µ–Ω–∏—è –∑–∞–ø–∏—Å—å—é —Å –¥–≤—É—Ö—Ñ–∞–∑–Ω–æ–π –º–æ–¥–µ–ª—å—é:

```sql
create or replace function public.is_queue_owner(q queue)
returns boolean
language sql
security definer
set search_path = public
as $$
  select
    -- –§–∞–∑–∞ 1: –∑–∞–ø–∏—Å—å —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ user_id
    (q.user_id is not null and q.user_id = auth.uid())
    OR
    -- –§–∞–∑–∞ 2: –∑–∞–ø–∏—Å—å –µ—â—ë –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞, –Ω–æ —Å—Ç—É–¥–µ–Ω—Ç –º–æ–π (–æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ)
    (
      q.user_id is null
      and exists (
        select 1
        from students s
        where s.id = q.student_id
          and s.user_id = auth.uid()
      )
    );
$$;
```

**–°—Ü–µ–Ω–∞—Ä–∏–∏:**
- ‚úÖ **–°—Ç—É–¥–µ–Ω—Ç —Å–æ–∑–¥–∞–ª —Å–∞–º** ‚Üí `user_id = auth.uid()` ‚Üí true
- ‚úÖ **–ê–¥–º–∏–Ω —Å–æ–∑–¥–∞–ª** ‚Üí `user_id = NULL` ‚Üí —Å—Ç—É–¥–µ–Ω—Ç –ª–æ–≥–∏–Ω–∏—Ç—Å—è ‚Üí true
- ‚ùå **–ß—É–∂–∞—è –∑–∞–ø–∏—Å—å** ‚Üí `user_id ‚â† auth.uid()` –ò `students.user_id ‚â† auth.uid()` ‚Üí false

---

## üîÑ –ó–∞—á–µ–º –Ω—É–∂–µ–Ω `claim_my_queue_items()`

RPC —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–ø—Ä–∏–≤—è–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ —Å—Ç—É–¥–µ–Ω—Ç–∞:

```sql
create or replace function public.claim_my_queue_items()
returns void
language plpgsql
security definer
set search_path = public
as $$
begin
  update queue q
  set user_id = auth.uid()
  where q.user_id is null
    and exists (
      select 1
      from students s
      where s.id = q.student_id
        and s.user_id = auth.uid()
    );
end;
$$;
```

**–ó–∞—á–µ–º:**
- üîÑ **–ê–≤—Ç–æ–ø—Ä–∏–≤—è–∑–∫–∞** - —Å—Ç—É–¥–µ–Ω—Ç –ª–æ–≥–∏–Ω–∏—Ç—Å—è ‚Üí "–ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç" –∞–¥–º–∏–Ω—Å–∫–∏–µ –∑–∞–ø–∏—Å–∏
- üîí **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - `SECURITY DEFINER` –æ–±—Ö–æ–¥–∏—Ç RLS, –Ω–æ `auth.uid()` –∑–∞—â–∏—â–∞–µ—Ç
- üö´ **–ë–µ–∑ 403** - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤ –Ω–∞ UPDATE —Ç–∞–±–ª–∏—Ü—ã queue
- ‚ö° **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å** - —Å—Ç—É–¥–µ–Ω—Ç –º–æ–∂–µ—Ç –∑–∞–±—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ –°–í–û–ò –∑–∞–ø–∏—Å–∏

**–ö–æ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è:**
- –ü—Ä–∏ –∫–∞–∂–¥–æ–º –ª–æ–≥–∏–Ω–µ —Å—Ç—É–¥–µ–Ω—Ç–∞ –≤ `refreshMyRole()`
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ–ø—Ä–∏–≤—è–∑–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç UI —á–µ—Ä–µ–∑ `fetchQueue()`

---

## üåç –ü–æ—á–µ–º—É `get_queue_active`

RPC —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ –≤—Å–µ –¥–∞—Ç—ã:

```sql
create or replace function public.get_queue_active()
returns setof queue
language sql
security definer
set search_path = public
as $$
  select *
  from queue
  where status in ('waiting', 'ready', 'key_issued', 'washing', 'returning_key')
  order by queue_date, queue_position;
$$;
```

**–ó–∞—á–µ–º:**
- üåç **–í—Å–µ –¥–∞—Ç—ã** - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—á–µ—Ä–µ–¥—å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∏ –±—É–¥—É—â–∏–µ –¥–∞—Ç—ã
- ‚ö° **–ê–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ–ª—å–∫–æ** - —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏
- üìã **–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞** - –ø–æ –¥–∞—Ç–µ –∏ –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞
- üîí **–ü—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø** - `SECURITY DEFINER` –æ–±—Ö–æ–¥–∏—Ç RLS –¥–ª—è —á—Ç–µ–Ω–∏—è

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–µ—Ä–µ–¥ `get_queue_public`:**
- ‚ùå `get_queue_public(p_date)` - —Ç–æ–ª—å–∫–æ –Ω–∞ –æ–¥–Ω—É –¥–∞—Ç—É
- ‚úÖ `get_queue_active()` - –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø–∏—Å–∏
- üéØ **UI —É–¥–æ–±—Å—Ç–≤–æ** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –≤—Å—é –∫–∞—Ä—Ç–∏–Ω—É

---

## üèóÔ∏è –ò—Ç–æ–≥–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### Flow:
1. **–ê–¥–º–∏–Ω —Å–æ–∑–¥–∞–µ—Ç** ‚Üí `student_id=X, user_id=NULL`
2. **–°—Ç—É–¥–µ–Ω—Ç –ª–æ–≥–∏–Ω–∏—Ç—Å—è** ‚Üí `claim_my_queue_items()` ‚Üí `user_id=auth.uid()`
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–Ω–∏—è** ‚Üí `is_queue_owner()` ‚Üí true –¥–ª—è —Å–≤–æ–∏—Ö –∑–∞–ø–∏—Å–µ–π
4. **UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç** ‚Üí `get_queue_active()` ‚Üí –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø–∏—Å–∏

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- **RLS –ø–æ–ª–∏—Ç–∏–∫–∏** –∏—Å–ø–æ–ª—å–∑—É—é—Ç `is_queue_owner()` –¥–ª—è DELETE/UPDATE
- **RPC —Ñ—É–Ω–∫—Ü–∏–∏** –∏—Å–ø–æ–ª—å–∑—É—é—Ç `SECURITY DEFINER` –¥–ª—è –æ–±—Ö–æ–¥–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- **auth.uid()** –≤—Å–µ–≥–¥–∞ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç —á—É–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö

### –†–µ–∑—É–ª—å—Ç–∞—Ç:
- üéØ **–ê–¥–º–∏–Ω –º–æ–∂–µ—Ç —Å—Ç–∞–≤–∏—Ç—å –ª—é–±–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞**
- üîÑ **–°—Ç—É–¥–µ–Ω—Ç –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ**
- üîí **–ù–∏–∫—Ç–æ –Ω–µ –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —á—É–∂–∏–º–∏ –∑–∞–ø–∏—Å—è–º–∏**
- üö´ **–ù–∏–∫–∞–∫–∏—Ö 403 –æ—à–∏–±–æ–∫**
